<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Yet Another Stateless Authentication Blog Post for the MEAN stack. | James Hughes</title>
<meta name=keywords content="nodejs,REST,JWT,ExpressJS,Middleware,development,JavaScript,MongoDB,async"><meta name=description content="#inb4: this ain&rsquo;t new.
I&rsquo;m writing this for everyone that wants a slightly more organized approach to express middleware and authentication.  I&rsquo;m writing this because once again I was inspired by how much I adore Node, Express, and all the delights that come from being able to implement my API&rsquo;s and leverage middlewares.  Also, I&rsquo;m using async / await, which is pretty neat.
I&rsquo;m going to use MongoDB as a datastore it just jives so well with Node."><meta name=author content="James D Hughes"><link rel=canonical href=https://blog.jimdhughes.com/posts/2018/yet-another-stateless-authentication-blog-post-for-the-mean-stack/><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.jimdhughes.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.jimdhughes.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.jimdhughes.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.jimdhughes.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.jimdhughes.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.jimdhughes.com/posts/2018/yet-another-stateless-authentication-blog-post-for-the-mean-stack/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0ET0VYDXCL"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0ET0VYDXCL")</script><meta property="og:url" content="https://blog.jimdhughes.com/posts/2018/yet-another-stateless-authentication-blog-post-for-the-mean-stack/"><meta property="og:site_name" content="James Hughes"><meta property="og:title" content="Yet Another Stateless Authentication Blog Post for the MEAN stack."><meta property="og:description" content="#inb4: this ain’t new.
I’m writing this for everyone that wants a slightly more organized approach to express middleware and authentication. I’m writing this because once again I was inspired by how much I adore Node, Express, and all the delights that come from being able to implement my API’s and leverage middlewares. Also, I’m using async / await, which is pretty neat.
I’m going to use MongoDB as a datastore it just jives so well with Node."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-05T03:32:35+00:00"><meta property="article:modified_time" content="2018-05-05T03:32:35+00:00"><meta property="article:tag" content="Nodejs"><meta property="article:tag" content="REST"><meta property="article:tag" content="JWT"><meta property="article:tag" content="ExpressJS"><meta property="article:tag" content="Middleware"><meta property="article:tag" content="Development"><meta name=twitter:card content="summary"><meta name=twitter:title content="Yet Another Stateless Authentication Blog Post for the MEAN stack."><meta name=twitter:description content="#inb4: this ain&rsquo;t new.
I&rsquo;m writing this for everyone that wants a slightly more organized approach to express middleware and authentication.  I&rsquo;m writing this because once again I was inspired by how much I adore Node, Express, and all the delights that come from being able to implement my API&rsquo;s and leverage middlewares.  Also, I&rsquo;m using async / await, which is pretty neat.
I&rsquo;m going to use MongoDB as a datastore it just jives so well with Node."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Yet Another Stateless Authentication Blog Post for the MEAN stack.","item":"https://blog.jimdhughes.com/posts/2018/yet-another-stateless-authentication-blog-post-for-the-mean-stack/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Yet Another Stateless Authentication Blog Post for the MEAN stack.","name":"Yet Another Stateless Authentication Blog Post for the MEAN stack.","description":"#inb4: this ain\u0026rsquo;t new.\nI\u0026rsquo;m writing this for everyone that wants a slightly more organized approach to express middleware and authentication. I\u0026rsquo;m writing this because once again I was inspired by how much I adore Node, Express, and all the delights that come from being able to implement my API\u0026rsquo;s and leverage middlewares. Also, I\u0026rsquo;m using async / await, which is pretty neat.\nI\u0026rsquo;m going to use MongoDB as a datastore it just jives so well with Node.\n","keywords":["nodejs","REST","JWT","ExpressJS","Middleware","development","JavaScript","MongoDB","async"],"articleBody":"#inb4: this ain’t new.\nI’m writing this for everyone that wants a slightly more organized approach to express middleware and authentication. I’m writing this because once again I was inspired by how much I adore Node, Express, and all the delights that come from being able to implement my API’s and leverage middlewares. Also, I’m using async / await, which is pretty neat.\nI’m going to use MongoDB as a datastore it just jives so well with Node.\nSo - let’s bootstrap if you don’t have express-generator installed, do it. npm i -g express-generator\n$ express express-jwt-tutorial $ cd express-jwt-tutorial $ npm i jsonwebtoken mongoose bcryptjs --save I like to add my folders immediately after I make a new project so…\n$ mkdir models $ mkdir middleware $ mkdir config First things first - our user model:\n//models/user.model.js const mongoose = require('mongoose'); const bcrypt = require('bcryptjs'); const userSchema = mongoose.Schema({ email:{type:String, required:true, unique:true}, password:{type:String, required:true} }); //encrpyt a password userSchema.methods.generateHash = function(password) { return bcrypt.hashSync(password, 10, null); } //Check to see if password is a valid hash userSchema.methods.validPassword = function(password) { return bcrypt.compareSync(password, this.password); } //Hash password if it's been changed userSchema.pre('save', function(next){ if(this.isModified('password')){ console.log('password changed'); this.password = this.generateHash(this.password); } next(); }); //export the model module.exports = mongoose.model('User', userSchema); I added in some methods to create and validate hashes for passwords. Never store those passwords in plain text!\nBelow is an example mongodb configuration file that I’ll put in the config folder\n// config/db.js module.exports = { development:'mongodb://localhost/someapp' } I like to keep my mongodb initializations in one file. Set up the connections, load up the models, etc. This makes it easy to get the app up and running with a single line of code later. Below is an example of how I do this.\n// models/index.js const mongoose = require('mongoose'); const env = process.env.NODE_ENV || 'development'; const db = require('../config/db')[env]; mongoose.connect(db); require('./user.model'); Onto bootstrapping…\nIn app.js I usually do the following immediately:\nDelete the predefined index and user routes Delete the predefined route mappings denoted by app.use('/', indexRouter) and app.use('/users/', usersRouter) Next: initialize mongo by adding a require line. I typically put this just below the app initialization:\n//app.js ... var app = express(); //Load Mongoose Models require('./models'); // view engine setup ... Run it! You can use npm start, or whatever mechanism you like to use to get your app up and running. I like to use nodemon for livereload, but it’s totally up to you.\nDefine some Routes Time to define some endpoints! Again - I have a flavour of setup that I like to use - so that’s what I’m going to show! Under the routes folder, open up index, wipe it out, and add the following:\n// routes/index.js module.exports = { users:require('./users') } Open up users and replace it with the following:\n//routes/users.js const router = require('express').Router(); router.route('/') .get(getUsers); router.route('/:id') .get(getUser); module.exports = router; async function getUsers(req, res, next){ next(new Error('Not Yet Implemented')); } async function getUser(req, res, next) { next(new Error('Not Yet Implemented')); } Now it’s pretty easy to set up our endpoints. Return to app.js and add the following code. You will need to import it after you load your mongoose models.\n//app.js //Load Mongoose Models require('./models'); var routes = require('./routes'); ... // Middleware ... app.use('/api/v1/users', routes.users); We’ve written all this code – but haven’t actually done anything yet.\nLet’s build in some funcitonality! We’ll start with registration and authentication. Some people will suggest you use something like passport.js - which I have used previously. However since I am going to go stateless, I find it completely unnecessary to do this when it really just takes a few lines of code!\nGo ahead and create your authentication router.\n// routes/authentication.js const router = require('express').Router(); const User = require('mongoose').model('User'); router.route('/login') .post(doLogin) router.route('/register') .post(doRegister); module.exports = router; async function doLogin(req, res, next) { next(new Error('Not Yet Implemented')); } async function doRegister(req, res, next) { next(new Error('Not Yet Implemented')); } To handle a registration, life is pretty easy. We can just create a new user. Our Mongoose Model definition will handle the encrypting of passwords and the like for us so we don’t really need to worry too much about this. We could maybe add some validations, but they’re not totally necessary.\n... async function doRegister(req, res, next) { let user = req.body; if (!user.email) { return res.status(400).json({ message: 'Require Email For User' }); } if (!user.password) { return res.status(400).json({ message: 'Require Password For User' }); } try { let result = await User.create(user); res.status(201).json({message:'Successfully Registered! Please Login'}); } catch(err) { //You can handle this better. I'm not going to though next(err); } } I’m not going to give you a tutorial on how to issue HTTP requests. I use Postman on windows and CURL or Postman on Linux. It’s up to you, but you can now POST to api/v1/auth/register and send a body with an email and password and we can now register! It’s that easy! After you post a user to api/v1/auth/register, you should get a return value with our little json message: ‘Successfully Registered! Please Login’. Which I would LOVE to do… If I had a login method!\nSo to create a login controller:\n... async function doLogin(req, res, next) { let credentials = req.body; if(!credentials.email) { return res.status(400).json({message:'Require Email'}); } if(!credentials.password) { return res.status(400).json({message:' Require Password'}); } try { let u = await User.findOne({email:credentials.email}); if(!u) { return res.status(404).json({message:'User Not Found!'}); } let validPassword = u.validPassword(credentials.password); if(!validPassword) { return res.status(401).json({message:'Invalid Username / Password combination'}); } return res.status(200).json({message:'Welcome!'}); } catch(err) { next(err); } } ... Go ahead and POST your email / password to the api/v1/auth/login endpoint and you will get our nice Welcome message.\nBut wait – This doesn’t really DO anything. Sure your challenge is correct, and if you wanted to send an email and password on every request you COULD do it this way.. OR you could sign a json web token! That’s what we’re going to do. First - We need to set up a secret for our app. This will need to be shared across all servers that could handle your authentication so it can get a bit tricky. You could use a super secure key or a RSA cert or the like. We’re going to just use a big string.\nSo - let’s make an app config file at config/properties.js\n// config/properties.js module.exports = { secret:'thisisasecretthatisnotinsecureatall' } Go back to routes/authentication.js and import the jsonwebtoken library.\n// routes/authentication.js ... const jwt = require('jsonwebtoken'); const config = require('../config/properties'); ... Now we can update our doLogin function to create a token and send it back to the client! We’re going to add code JUST before we return the success message.\nasync function doLogin(req, res, next) { ... let token = jwt.sign({id:u._id}, config.secret); return res.status(200).json({message:'Welcome!', token: token}); ... } If you POST a login again, you will get the welcome message AND a token! Make sure you keep it safe ;) (Truth be told, plain old json sending a token is probably not the best idea. Using a cookie or something might be a little more secure, regardless. There’s some potential security issues)\nNow, what do you do next? We have this token, and logging in, but what is the POINT of it all? Well, we need to secure some endpoints. Let’s set it up so that a user can access their profile with a new router: routes/me.js\n// routes/me.js const router = require('express').Router(); router.route('/') .get(getMe); module.exports = router; async function getMe(req, res, next) { next(new Error('Not Yet Implemented')); } This would be neat, but if you’re thinking even remotely logically - you will know why this is pointless. Nothing exists to determine who it is that’s making the request! That’s where the joyous middleware comes into play.\nLet’s make a new middleware file at: middleware/checkToken.js\n// middleware/checkToken.js const jwt = require('jsonwebtoken'); const config = require('../config/properties'); const User = require('mongoose').model('User'); module.exports = async function(req, res, next) { let token = req.headers['x-auth-token']; if(!token) { return res.status(403).json({message:'No Token Provided'}); } try{ let payload = await jwt.verify(token, config.secret); let u = await User.findOne({id:payload._id}, {password:false}); req.user = u; next(); } catch(err) { res.status(403).json({message:'Invalid Token'}); } } Then it’s super easy to use! Add this middleware before each call in your routes/me.js or any route you want to be secured by at minimum an authentication!\n// routes/me.js const router = require('express').Router(); const checkToken = require('../middleware/checkToken'); router.route('/') .get(checkToken, getMe); module.exports = router; async function getMe(req, res, next) { res.json(req.user); } Add me.js to your routes/index.js in the same manner as the other imports:\n// routes/index.js module.exports = { users: require('./users'), authentication: require('./authentication'), me: require('./me') } Then add an endpoint in app.js app.use(’/api/v1/me’, routes.me);\nAdd the x-auth-token header to your api/v1/me request with the token that was generated from your login and boom! You’ve got authorization! Try again without sending a token and you will get our ‘No Token Provided’ message. Pretty cool, yeah?\nThis is pretty simple example, but what I really wanted to discuss is next. The middleware for even more functionality!\nAdding in some permission-level authentication in this is super easy now that we have this architecture. First things first, let’s adjust our user model to have a ‘role’ property that can be any of ‘user’, ‘admin’, or ‘manager’. It’ll look something like this:\n// models/user.model.js ... const userSchema = mongoose.Schema({ email:{type:String, required:true, unique:true}, password:{type:String, required:true}, role:{type:String, enum:['user', 'admin', 'manager'], required:true, default:'user'} }); ... For entertainment purposes, we’re going to add a new resource and simply call it asset. We will need a mongoose model for it to begin:\n// models/asset.model.js const mongoose = require('mongoose'); const assetSchema = mongoose.Schema({ title:{type:String, required:true}, properties:{type:Object}, assignedTo:{type:mongoose.Schema.Types.ObjectId, required:false}, assignedAt:{type: Date, default: function() { return new Date()}} }); module.exports = mongoose.model('Asset', assetSchema); Require it in our models/index.js file as we did previously:\n// models/index.js ... require('./asset.model'); ... Next we’ll make a basic CRUD router for the asset:\n// routes/assets.js const router = require('express').Router(); router.route('/') .get(getAssets) .post(createAsset); router.route('/:id') .get(getAsset) .put(updateAsset) .delete(deleteAsset); module.exports = router; async function getAssets(req, res, next) { next(new Error('Not Yet Implemented')); } async function createAsset(req, res, next) { next(new Error('Not Yet Implemented')); } async function getAsset(req, res, next) { next(new Error('Not Yet Implemented')); } async function updateAsset(req, res, next) { next(new Error('Not Yet Implemented')); } async function deleteAsset(req, res, next) { next(new Error('Not Yet Implemented')); } Then add it to our index and app.js as we did previously.\n// SEE ABOVE. It's the exact same as before // routes/index.js ... assets:require('./assets') ... //app.js app.use('/api/v1/assets', routes.assets); The use case for this asset is as follows:\nAssets can be assigned to any user Administrators can assign assets to any individual Users can only view the assets that are assigned to them Manager can view all assets but can’t edit or create them. The first and foremost requirement of all of these scenarios is that a user must be authenticated to view. So to do this, we add the checkToken middleware to all those routes.\n// routes/asset.js const router = require('express').Router(); const checkToken = require('../middleware/checkToken'); router.route('/') .get(checkToken, getAssets) .post(checkToken, createAsset); router.route('/:id') .get(checkToken, getAsset) .put(checkToken, updateAsset) .delete(checkToken, deleteAsset); ... This is all fine and dandy, but what about those role requirements? More middleware? More middleware!\n// middleware/authorize.js module.exports = { hasRole: function(role) { return function(req, res, next) { if(role === req.user.role) { next(); } else{ return res.status(403).json({message:'Unauthorized'}); } } }, hasAnyRole: function(roles) { return function(req, res, next) { let authorized = false; if(!(roles instanceof Array)) { roles = [roles]; } roles.forEach(r =\u003e { if(r === req.user.role) { authorized = true; } }); if(authorized){ next(); } else{ return res.status(403).json({message:'Unauthorized'}); } } } } This will allow us to implement all sorts of combinations of permission checking! I implemented the two that I need right now, but if you had an app with some more complicated permissions structure you could do something like hasAllRoles or doesNotHaveRole or hasNoRoles for some reason.\nNext we can just chain these into our endpoints in our asset router.\n//routes/asset.js const router = require('express').Router(); const Asset = require('mongoose').model('Asset'); const checkToken = require('../middleware/checkToken'); const authorize = require('../middleware/authorize'); router.route('/') .get(checkToken, authorize.hasAnyRole(['admin', 'manager']), getAssets) .post(checkToken, authorize.hasRole('admin'), createAsset); router.route('/:id') .get(checkToken, authorize.hasAnyRole(['admin', 'manager']), getAsset) .put(checkToken, authorize.hasRole('admin'), updateAsset) .delete(checkToken, authorize.hasRole('admin'), deleteAsset); Note that I put the checkToken middleware first. This is because it allows us to check for a token first (and if there isn’t one, end the request) and insert the user represented by the token into the request data. It is then accessible by the next piece of middleware.\nOnce we implement the rest of our functions, the asset class will look something like this:\nconst router = require('express').Router(); const Asset = require('mongoose').model('Asset'); const checkToken = require('../middleware/checkToken'); const authorize = require('../middleware/authorize'); router.route('/') .get(checkToken, authorize.hasAnyRole(['admin', 'manager']), getAssets) .post(checkToken, authorize.hasRole('admin'), createAsset); router.route('/:id') .get(checkToken, authorize.hasAnyRole(['admin', 'manager']), getAsset) .put(checkToken, authorize.hasRole('admin'), updateAsset) .delete(checkToken, authorize.hasRole('admin'), deleteAsset); module.exports = router; async function getAssets(req, res, next) { try { let assets = await Asset.find(); res.json(assets); } catch(err) { next(err); } } async function createAsset(req, res, next) { let asset = req.body; try { let a = await Asset.create(asset); res.status(201).json(a); } catch(err) { next(err); } } async function getAsset(req, res, next) { let id = req.params.id; try { let asset = await Asset.findById(id); res.json(asset); } catch(err) { next(err); } } async function updateAsset(req, res, next) { let id = req.params.id; let asset = req.body; try { let result = await Asset.update({_id:id}, asset, {new:true}); res.json(result); } catch(err) { next(err); } } async function deleteAsset(req, res, next) { let id = req.params.id; try { let done = await Asset.deleteOne({_id:id}); if(done) { return res.status(200).json({message:'Deleted'}); } } catch(err) { next(err); } } I’m not going to prove it, but if you want to test the use cases, go ahead and make a couple of users and try to access each endpoint as each of them :D.\nFor most API’s I’ve grown quite fond of implementing features for individuals with the /me endpoint. To complete our previous list of user requirements, I’m going to simply implement the feature for getting assets but by using the /me endpoint as the only requirement is not permissions based, but identity based.\n// routes/me.js ... router.route('/assets') .get(checkToken, getMyAssets); ... async function getMyAssets(req, res, next) { try { let assets = await Asset.find({ assignedTo: req.user._id }); res.json(assets); } catch (err) { next(err); } } and Voila. We can get all the assets that’s assigned to the currently authenticated user.\nIsn’t that fun?\nI’m going to post the source code on my github - I’ll update the post when I do!\nThe source is up at https://github.com/jimdhughes/jdhc-express-stateless-template\nCheers!\n","wordCount":"2405","inLanguage":"en","datePublished":"2018-05-05T03:32:35Z","dateModified":"2018-05-05T03:32:35Z","author":{"@type":"Person","name":"James D Hughes"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.jimdhughes.com/posts/2018/yet-another-stateless-authentication-blog-post-for-the-mean-stack/"},"publisher":{"@type":"Organization","name":"James Hughes","logo":{"@type":"ImageObject","url":"https://blog.jimdhughes.com/favicon.ico"}}}</script></head><body id="
  top"><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.jimdhughes.com/ accesskey=h title="James Hughes (Alt + H)">James Hughes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Yet Another Stateless Authentication Blog Post for the MEAN stack.</h1><div class=post-meta><span title='2018-05-05 03:32:35 +0000 UTC'>May 5, 2018</span>&nbsp;·&nbsp;James D Hughes</div></header><div class=post-content><p>#inb4: this ain&rsquo;t new.</p><p>I&rsquo;m writing this for everyone that wants a <em>slightly</em> more organized approach to express middleware and authentication. I&rsquo;m writing this because once again I was inspired by how much I <strong>adore</strong> Node, Express, and all the delights that come from being able to implement my API&rsquo;s and leverage middlewares. Also, I&rsquo;m using async / await, which is pretty neat.</p><p>I&rsquo;m going to use MongoDB as a datastore it just jives so well with Node.</p><p>So - let&rsquo;s bootstrap if you don&rsquo;t have express-generator installed, do it. <code>npm i -g express-generator</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ express express-jwt-tutorial
</span></span><span style=display:flex><span>$ cd express-jwt-tutorial
</span></span><span style=display:flex><span>$ npm i jsonwebtoken mongoose bcryptjs --save
</span></span></code></pre></div><p>I like to add my folders immediately after I make a new project so&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ mkdir models
</span></span><span style=display:flex><span>$ mkdir middleware
</span></span><span style=display:flex><span>$ mkdir config
</span></span></code></pre></div><p>First things first - our user model:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>//models/user.model.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mongoose</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bcrypt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;bcryptjs&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userSchema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>Schema</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span>String, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>unique</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span>String, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>}
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//encrpyt a password
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>userSchema</span>.<span style=color:#a6e22e>methods</span>.<span style=color:#a6e22e>generateHash</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bcrypt</span>.<span style=color:#a6e22e>hashSync</span>(<span style=color:#a6e22e>password</span>, <span style=color:#ae81ff>10</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//Check to see if password is a valid hash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>userSchema</span>.<span style=color:#a6e22e>methods</span>.<span style=color:#a6e22e>validPassword</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bcrypt</span>.<span style=color:#a6e22e>compareSync</span>(<span style=color:#a6e22e>password</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//Hash password if it&#39;s been changed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>userSchema</span>.<span style=color:#a6e22e>pre</span>(<span style=color:#e6db74>&#39;save&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>next</span>){
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isModified</span>(<span style=color:#e6db74>&#39;password&#39;</span>)){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;password changed&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateHash</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//export the model
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;User&#39;</span>, <span style=color:#a6e22e>userSchema</span>);
</span></span></code></pre></div><p>I added in some methods to create and validate hashes for passwords. Never store those passwords in plain text!</p><p>Below is an example mongodb configuration file that I&rsquo;ll put in the <code>config</code> folder</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// config/db.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>development</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;mongodb://localhost/someapp&#39;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I like to keep my mongodb initializations in one file. Set up the connections, load up the models, etc. This makes it easy to get the app up and running with a single line of code later. Below is an example of how I do this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// models/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mongoose</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>env</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NODE_ENV</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;development&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../config/db&#39;</span>)[<span style=color:#a6e22e>env</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>connect</span>(<span style=color:#a6e22e>db</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./user.model&#39;</span>);
</span></span></code></pre></div><p>Onto bootstrapping&mldr;</p><p>In <code>app.js</code> I usually do the following immediately:</p><ol><li>Delete the predefined <code>index</code> and <code>user</code> routes</li><li>Delete the predefined route mappings denoted by <code>app.use('/', indexRouter)</code> and <code>app.use('/users/', usersRouter)</code></li></ol><p>Next: initialize mongo by adding a require line. I typically put this just below the app initialization:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>//app.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//Load Mongoose Models
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./models&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// view engine setup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span></code></pre></div><h1 id=run-it>Run it!<a hidden class=anchor aria-hidden=true href=#run-it>#</a></h1><p>You can use npm start, or whatever mechanism you like to use to get your app up and running. I like to use nodemon for livereload, but it&rsquo;s totally up to you.</p><h1 id=define-some-routes>Define some Routes<a hidden class=anchor aria-hidden=true href=#define-some-routes>#</a></h1><p>Time to define some endpoints!
Again - I have a flavour of setup that I like to use - so that&rsquo;s what I&rsquo;m going to show!
Under the <code>routes</code> folder, open up <code>index</code>, wipe it out, and add the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span> <span style=color:#75715e>// routes/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>users</span><span style=color:#f92672>:</span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./users&#39;</span>)
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>Open up <code>users</code> and replace it with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>//routes/users.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>).<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>getUsers</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/:id&#39;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>getUser</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getUsers</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>){
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getUser</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now it&rsquo;s pretty easy to set up our endpoints. Return to app.js and add the following code. You will need to import it after you load your mongoose models.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>//app.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//Load Mongoose Models
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./models&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>routes</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./routes&#39;</span>);
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e>// Middleware
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#39;/api/v1/users&#39;</span>, <span style=color:#a6e22e>routes</span>.<span style=color:#a6e22e>users</span>);
</span></span></code></pre></div><p>We&rsquo;ve written all this code &ndash; but haven&rsquo;t actually done anything yet.</p><p>Let&rsquo;s build in some funcitonality! We&rsquo;ll start with registration and authentication. Some people will suggest you use something like passport.js - which I have used previously. However since I am going to go stateless, I find it completely unnecessary to do this when it really just takes a few lines of code!</p><p>Go ahead and create your authentication router.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// routes/authentication.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>).<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>).<span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;User&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/login&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>post</span>(<span style=color:#a6e22e>doLogin</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/register&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>post</span>(<span style=color:#a6e22e>doRegister</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>doLogin</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>doRegister</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To handle a registration, life is pretty easy. We can just create a new user. Our Mongoose Model definition will handle the encrypting of passwords and the like for us so we don&rsquo;t really need to worry too much about this. We could maybe add some validations, but they&rsquo;re not totally necessary.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>doRegister</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>email</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Require Email For User&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Require Password For User&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>201</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Successfully Registered! Please Login&#39;</span>});
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//You can handle this better.  I&#39;m not going to though
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m not going to give you a tutorial on how to issue HTTP requests. I use Postman on windows and CURL or Postman on Linux. It&rsquo;s up to you, but you can now POST to api/v1/auth/register and send a body with an email and password and we can now register! It&rsquo;s that easy! After you post a user to api/v1/auth/register, you should get a return value with our little json message: &lsquo;Successfully Registered! Please Login&rsquo;. Which I would LOVE to do&mldr; If I had a login method!</p><p>So to create a login controller:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>doLogin</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>credentials</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>email</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Require Email&#39;</span>});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39; Require Password&#39;</span>});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>u</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({<span style=color:#a6e22e>email</span><span style=color:#f92672>:</span><span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>email</span>});
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>u</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>404</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;User Not Found!&#39;</span>});
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>validPassword</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>validPassword</span>(<span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>password</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>validPassword</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Invalid Username / Password combination&#39;</span>});
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Welcome!&#39;</span>});
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Go ahead and POST your email / password to the <code>api/v1/auth/login</code> endpoint and you will get our nice Welcome message.</p><p>But wait &ndash;
This doesn&rsquo;t really DO anything. Sure your challenge is correct, and if you wanted to send an email and password on every request you COULD do it this way.. OR you could sign a json web token!
That&rsquo;s what we&rsquo;re going to do.
First - We need to set up a secret for our app. This will need to be shared across all servers that could handle your authentication so it can get a bit tricky. You could use a super secure key or a RSA cert or the like. We&rsquo;re going to just use a big string.</p><p>So - let&rsquo;s make an app config file at <code>config/properties.js</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// config/properties.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>secret</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;thisisasecretthatisnotinsecureatall&#39;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Go back to <code>routes/authentication.js</code> and import the jsonwebtoken library.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// routes/authentication.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;jsonwebtoken&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../config/properties&#39;</span>);
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Now we can update our doLogin function to create a token and send it back to the client! We&rsquo;re going to add code JUST before we return the success message.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>doLogin</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>token</span>  <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>({<span style=color:#a6e22e>id</span><span style=color:#f92672>:</span><span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>_id</span>}, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Welcome!&#39;</span>, <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>token</span>});
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you POST a login again, you will get the welcome message AND a token! Make sure you keep it safe ;) (Truth be told, plain old json sending a token is probably not the best idea. Using a cookie or something might be a little more secure, regardless. There&rsquo;s some potential security issues)</p><p>Now, what do you do next? We have this token, and logging in, but what is the POINT of it all?
Well, we need to secure some endpoints. Let&rsquo;s set it up so that a user can access their profile with a new router: <code>routes/me.js</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// routes/me.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>).<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>getMe</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getMe</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This would be neat, but if you&rsquo;re thinking even remotely logically - you will know why this is pointless. Nothing exists to determine who it is that&rsquo;s making the request! That&rsquo;s where the joyous middleware comes into play.</p><p>Let&rsquo;s make a new middleware file at: <code>middleware/checkToken.js</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// middleware/checkToken.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;jsonwebtoken&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../config/properties&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>).<span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;User&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#39;x-auth-token&#39;</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;No Token Provided&#39;</span>});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>payload</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>u</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({<span style=color:#a6e22e>id</span><span style=color:#f92672>:</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>_id</span>}, {<span style=color:#a6e22e>password</span><span style=color:#f92672>:</span><span style=color:#66d9ef>false</span>});
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>u</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Invalid Token&#39;</span>});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then it&rsquo;s super easy to use! Add this middleware before each call in your <code>routes/me.js</code> or any route you want to be secured by at minimum an authentication!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// routes/me.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>).<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>checkToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../middleware/checkToken&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>getMe</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getMe</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Add <code>me.js</code> to your <code>routes/index.js</code> in the same manner as the other imports:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// routes/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>users</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./users&#39;</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authentication</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./authentication&#39;</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>me</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./me&#39;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then add an endpoint in <code>app.js</code>
app.use(&rsquo;/api/v1/me&rsquo;, routes.me);</p><p>Add the <code>x-auth-token</code> header to your <code>api/v1/me</code> request with the token that was generated from your login and boom! You&rsquo;ve got authorization!
Try again without sending a token and you will get our &lsquo;No Token Provided&rsquo; message.
Pretty cool, yeah?</p><p>This is pretty simple example, but what I really wanted to discuss is next. The middleware for even more functionality!</p><p>Adding in some permission-level authentication in this is super easy now that we have this architecture. First things first, let&rsquo;s adjust our user model to have a &lsquo;role&rsquo; property that can be any of &lsquo;user&rsquo;, &lsquo;admin&rsquo;, or &lsquo;manager&rsquo;. It&rsquo;ll look something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// models/user.model.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userSchema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>Schema</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span>String, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>unique</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span>String, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span>String, <span style=color:#66d9ef>enum</span><span style=color:#f92672>:</span>[<span style=color:#e6db74>&#39;user&#39;</span>, <span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;manager&#39;</span>], <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;user&#39;</span>}
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>For entertainment purposes, we&rsquo;re going to add a new resource and simply call it asset. We will need a mongoose model for it to begin:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// models/asset.model.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mongoose</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>assetSchema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>Schema</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span>String, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>},
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>properties</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span>Object},
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>assignedTo</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span><span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>Schema</span>.<span style=color:#a6e22e>Types</span>.<span style=color:#a6e22e>ObjectId</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span><span style=color:#66d9ef>false</span>},
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>assignedAt</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> Date, <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>() { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Date()}}
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;Asset&#39;</span>, <span style=color:#a6e22e>assetSchema</span>);
</span></span></code></pre></div><p>Require it in our <code>models/index.js</code> file as we did previously:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// models/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span><span style=display:flex><span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./asset.model&#39;</span>);
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Next we&rsquo;ll make a basic CRUD router for the asset:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// routes/assets.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>).<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>getAssets</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>post</span>(<span style=color:#a6e22e>createAsset</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/:id&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>getAsset</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>updateAsset</span>)
</span></span><span style=display:flex><span>  .<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>deleteAsset</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getAssets</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createAsset</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getAsset</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>updateAsset</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>deleteAsset</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Not Yet Implemented&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then add it to our index and app.js as we did previously.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// SEE ABOVE. It&#39;s the exact same as before
</span></span></span><span style=display:flex><span><span style=color:#75715e>// routes/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span><span style=display:flex><span><span style=color:#a6e22e>assets</span><span style=color:#f92672>:</span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./assets&#39;</span>)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//app.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#39;/api/v1/assets&#39;</span>, <span style=color:#a6e22e>routes</span>.<span style=color:#a6e22e>assets</span>);
</span></span></code></pre></div><p>The use case for this asset is as follows:</p><ol><li>Assets can be assigned to any user</li><li>Administrators can assign assets to any individual</li><li>Users can only view the assets that are assigned to them</li><li>Manager can view all assets but can&rsquo;t edit or create them.</li></ol><p>The first and foremost requirement of all of these scenarios is that a user must be authenticated to view. So to do this, we add the <code>checkToken</code> middleware to all those routes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// routes/asset.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>).<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>checkToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../middleware/checkToken&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>getAssets</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>post</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>createAsset</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/:id&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>getAsset</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>updateAsset</span>)
</span></span><span style=display:flex><span>  .<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>deleteAsset</span>);
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>This is all fine and dandy, but what about those role requirements?
More middleware?
More middleware!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// middleware/authorize.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hasRole</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>role</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>role</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>role</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Unauthorized&#39;</span>});
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hasAnyRole</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>roles</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>authorized</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>(<span style=color:#a6e22e>roles</span> <span style=color:#66d9ef>instanceof</span> Array)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>roles</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>roles</span>];
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>r</span> =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>role</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>authorized</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>authorized</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Unauthorized&#39;</span>});
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This will allow us to implement all sorts of combinations of permission checking! I implemented the two that I need right now, but if you had an app with some more complicated permissions structure you could do something like <code>hasAllRoles</code> or <code>doesNotHaveRole</code> or <code>hasNoRoles</code> for some reason.</p><p>Next we can just chain these into our endpoints in our <code>asset</code> router.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>//routes/asset.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>).<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Asset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>).<span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;Asset&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>checkToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../middleware/checkToken&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authorize</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../middleware/authorize&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasAnyRole</span>([<span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;manager&#39;</span>]), <span style=color:#a6e22e>getAssets</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>post</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#39;admin&#39;</span>), <span style=color:#a6e22e>createAsset</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/:id&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasAnyRole</span>([<span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;manager&#39;</span>]), <span style=color:#a6e22e>getAsset</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#39;admin&#39;</span>), <span style=color:#a6e22e>updateAsset</span>)
</span></span><span style=display:flex><span>  .<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#39;admin&#39;</span>), <span style=color:#a6e22e>deleteAsset</span>);
</span></span></code></pre></div><p>Note that I put the checkToken middleware first. This is because it allows us to check for a token first (and if there isn&rsquo;t one, end the request) and insert the user represented by the token into the request data. It is then accessible by the next piece of middleware.</p><p>Once we implement the rest of our functions, the asset class will look something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>).<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Asset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>).<span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;Asset&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>checkToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../middleware/checkToken&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authorize</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../middleware/authorize&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasAnyRole</span>([<span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;manager&#39;</span>]), <span style=color:#a6e22e>getAssets</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>post</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#39;admin&#39;</span>), <span style=color:#a6e22e>createAsset</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/:id&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasAnyRole</span>([<span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;manager&#39;</span>]), <span style=color:#a6e22e>getAsset</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#39;admin&#39;</span>), <span style=color:#a6e22e>updateAsset</span>)
</span></span><span style=display:flex><span>  .<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>authorize</span>.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#39;admin&#39;</span>), <span style=color:#a6e22e>deleteAsset</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getAssets</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>assets</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Asset</span>.<span style=color:#a6e22e>find</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>assets</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createAsset</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>asset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Asset</span>.<span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>asset</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>201</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>a</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getAsset</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>asset</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Asset</span>.<span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>asset</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>updateAsset</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>asset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Asset</span>.<span style=color:#a6e22e>update</span>({<span style=color:#a6e22e>_id</span><span style=color:#f92672>:</span><span style=color:#a6e22e>id</span>}, <span style=color:#a6e22e>asset</span>, {<span style=color:#66d9ef>new</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>});
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>deleteAsset</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>done</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Asset</span>.<span style=color:#a6e22e>deleteOne</span>({<span style=color:#a6e22e>_id</span><span style=color:#f92672>:</span><span style=color:#a6e22e>id</span>});
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Deleted&#39;</span>});
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m not going to prove it, but if you want to test the use cases, go ahead and make a couple of users and try to access each endpoint as each of them :D.</p><p>For most API&rsquo;s I&rsquo;ve grown quite fond of implementing features for individuals with the <code>/me</code> endpoint. To complete our previous list of user requirements, I&rsquo;m going to simply implement the feature for getting assets but by using the <code>/me</code> endpoint as the only requirement is not permissions based, but identity based.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// routes/me.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#39;/assets&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>checkToken</span>, <span style=color:#a6e22e>getMyAssets</span>);
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getMyAssets</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>assets</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Asset</span>.<span style=color:#a6e22e>find</span>({ <span style=color:#a6e22e>assignedTo</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>_id</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>assets</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>and Voila. We can get all the assets that&rsquo;s assigned to the currently authenticated user.</p><p>Isn&rsquo;t that fun?</p><p><del>I&rsquo;m going to post the source code on my github - I&rsquo;ll update the post when I do!</del></p><p>The source is up at <a href=https://github.com/jimdhughes/jdhc-express-stateless-template>https://github.com/jimdhughes/jdhc-express-stateless-template</a></p><p>Cheers!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.jimdhughes.com/tags/nodejs/>Nodejs</a></li><li><a href=https://blog.jimdhughes.com/tags/rest/>REST</a></li><li><a href=https://blog.jimdhughes.com/tags/jwt/>JWT</a></li><li><a href=https://blog.jimdhughes.com/tags/expressjs/>ExpressJS</a></li><li><a href=https://blog.jimdhughes.com/tags/middleware/>Middleware</a></li><li><a href=https://blog.jimdhughes.com/tags/development/>Development</a></li><li><a href=https://blog.jimdhughes.com/tags/javascript/>JavaScript</a></li><li><a href=https://blog.jimdhughes.com/tags/mongodb/>MongoDB</a></li><li><a href=https://blog.jimdhughes.com/tags/async/>Async</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://blog.jimdhughes.com/>James Hughes</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>