<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>Go - Micro-services and Embedded Databases [Part 1]&nbsp;&ndash;&nbsp;James Hughes</title><link rel=stylesheet href=/css/core.min.99d761621eb15531f47d6f109c742c4d2f97f9c10fed380e3da27af7676a27a1fb5968bfbd3207717f11d40ad1d68b92.css integrity=sha384-mddhYh6xVTH0fW8QnHQsTS+X+cEP7TgOPaJ692dqJ6H7WWi/vTIHcX8R1ArR1ouS><meta name=twitter:card content="summary"><meta name=twitter:title content="Go - Micro-services and Embedded Databases [Part 1]"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">James Hughes</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories/>Categories</a><a class="nav item" href=/tags/>Tags</a><a class="nav item" href></a><a class="nav item" href></a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">Go - Micro-services and Embedded Databases [Part 1]</h1><p class="article date">Wednesday, September 19, 2018</p></section><article class="article markdown-body"><p>This is fun!</p><p>FYI - If you&rsquo;re looking for Part 2, it&rsquo;s <a href=https://blog.jimdhughes.com/go-micro-services-and-embedded-databases-part-2/ target=_blank>here</a>[.]</p><hr><p>I&rsquo;ve been meaning to learn a few of the things I&rsquo;m going to go over in this post. Firstly, I want to make an actual useful application using Go. I want it to be run as a microservice with it&rsquo;s own database. Instead of putting it in a docker container, I want to just use an embedded database that the executable can use.</p><p>We&rsquo;re going to build a user authentication and token validation app. It&rsquo;ll use REST for communication (gRPC may come later) and will store users using BoltDB. The server will allow registration, logging in, will issue tokens and will validate tokens.</p><p>The endpoints for our app will be:</p><p>POST /login - Takes an email and password and attempts to log a user in</p><p>POST /register - Takes an email and password an attempts to create a new user</p><p>POST /validateToken - checks a supplied token. If it&rsquo;s valid it sends back the information of the authenticated user.</p><p>We&rsquo;re going to use a couple golang libraries that seem pretty popular. For routing, we will use <a href=https://github.com/gorilla/mux target=_blank>gorilla/mux</a>, for the database we will use <a href=https://github.com/boltdb/bolt target=_blank>boltdb/bolt</a> and for password hashing we will use <a href=https://godoc.org/golang.org/x/crypto/bcrypt target=_blank>golang.org/x/crypto/bcrypt</a>. Go ahead and &lsquo;go get&rsquo; them and we&rsquo;ll dive right in.</p><p>I start every go project by making a main.go and printing a simple Hello, World! so let&rsquo;s start there again</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Hello, World!&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>It&rsquo;s kind of hard to figure out where to start next. I&rsquo;m going to elect to start by making my model. I&rsquo;m going to make a new file called <code>model.go</code> and it&rsquo;ll look like so:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=c1>// User structure for accounts
</span><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>ID</span>       <span class=kt>string</span> <span class=s>`</span><span class=s>json:&#34;id&#34;</span><span class=s>`</span>
	<span class=nx>Email</span>    <span class=kt>string</span> <span class=s>`</span><span class=s>json:&#34;email&#34;</span><span class=s>`</span>
	<span class=nx>Password</span> <span class=kt>string</span> <span class=s>`</span><span class=s>json:&#34;password&#34;</span><span class=s>`</span>
<span class=p>}</span>

</code></pre></div><p>Since we&rsquo;re going to need to encrypt and check password hashes, we may as well just attach it the the User struct. Let&rsquo;s do that next.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>
<span class=c1>// ...
</span><span class=c1></span>
<span class=c1>// HashPassword sets the users password to the bcrypt hashed version of said password
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>HashPassword</span><span class=p>(</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
	<span class=nx>password</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>bcrypt</span><span class=p>.</span><span class=nf>GenerateFromPassword</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>Password</span><span class=p>)</span><span class=p>,</span> <span class=mi>14</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>u</span><span class=p>.</span><span class=nx>Password</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>password</span><span class=p>)</span>
	<span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=c1>// CheckPassword compares a plain text password against the Hashed Password of the user
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>CheckPassword</span><span class=p>(</span><span class=nx>password</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>bcrypt</span><span class=p>.</span><span class=nf>CompareHashAndPassword</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>Password</span><span class=p>)</span><span class=p>,</span> <span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>password</span><span class=p>)</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=nx>We</span> <span class=nx>now</span> <span class=nx>have</span> <span class=nx>some</span> <span class=nx>testable</span> <span class=nx>code</span><span class=p>!</span> <span class=nx>For</span> <span class=nx>fun</span> <span class=nx>let</span><span class=err>&#39;</span><span class=nx>s</span> <span class=nx>write</span> <span class=nx>a</span> <span class=nx>test</span> <span class=k>for</span> <span class=nx>the</span> <span class=nx>password</span> <span class=nx>hasing</span><span class=p>!</span>

<span class=s>`</span><span class=s>`</span><span class=err>`</span><span class=k>go</span>
<span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;testing&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>TestUserPassword</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>password</span> <span class=o>:=</span> <span class=s>&#34;testpassword&#34;</span>
	<span class=nx>u</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
		<span class=nx>Email</span><span class=p>:</span>    <span class=s>&#34;testEmail@domain.com&#34;</span><span class=p>,</span>
		<span class=nx>Password</span><span class=p>:</span> <span class=nx>password</span><span class=p>,</span>
	<span class=p>}</span>
	<span class=nx>u</span><span class=p>.</span><span class=nf>HashPassword</span><span class=p>(</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Password</span> <span class=o>==</span> <span class=nx>password</span> <span class=p>{</span>
		<span class=c1>// Password failed to hash
</span><span class=c1></span>		<span class=nx>t</span><span class=p>.</span><span class=nf>Fail</span><span class=p>(</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>TestUserPasswordCompareCorrectPassword</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>password</span> <span class=o>:=</span> <span class=s>&#34;testpassword&#34;</span>
	<span class=nx>u</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
		<span class=nx>Email</span><span class=p>:</span>    <span class=s>&#34;testEmail@domain.com&#34;</span><span class=p>,</span>
		<span class=nx>Password</span><span class=p>:</span> <span class=nx>password</span><span class=p>,</span>
	<span class=p>}</span>

	<span class=nx>u</span><span class=p>.</span><span class=nf>HashPassword</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>u</span><span class=p>.</span><span class=nf>CheckPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>TestUserPasswordCompareIncorrectPassword</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>password</span> <span class=o>:=</span> <span class=s>&#34;testpassword&#34;</span>
	<span class=nx>u</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
		<span class=nx>Email</span><span class=p>:</span>    <span class=s>&#34;testEmail@domain.com&#34;</span><span class=p>,</span>
		<span class=nx>Password</span><span class=p>:</span> <span class=nx>password</span><span class=p>,</span>
	<span class=p>}</span>
	<span class=nx>password</span> <span class=p>=</span> <span class=s>&#34;nope!&#34;</span>
	<span class=nx>u</span><span class=p>.</span><span class=nf>HashPassword</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>u</span><span class=p>.</span><span class=nf>CheckPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>


</code></pre></div><p>Run these tests using <code>go test</code>. Everything should pass and now we can move on to making some actual functionality!</p><p>Next I want to make some placeholder routes to handle the requests we want to handle. To do this, let&rsquo;s make a new file called <code>router.go</code></p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;net/http&#34;</span>

	<span class=s>&#34;github.com/gorilla/mux&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>NewRouter</span><span class=p>(</span><span class=p>)</span> <span class=o>*</span><span class=nx>mux</span><span class=p>.</span><span class=nx>Router</span> <span class=p>{</span>
	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>NewRouter</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>,</span> <span class=nx>HandleLogin</span><span class=p>)</span><span class=p>.</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;POST&#34;</span><span class=p>)</span>
	<span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/register&#34;</span><span class=p>,</span> <span class=nx>HandleRegistration</span><span class=p>)</span><span class=p>.</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;POST&#34;</span><span class=p>)</span>
	<span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/validateToken&#34;</span><span class=p>,</span> <span class=nx>HandleValidateToken</span><span class=p>)</span><span class=p>.</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;POST&#34;</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>r</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>HandleLogin</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Not Yet Implemented&#34;</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>HandleRegistration</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Not Yet Implemented&#34;</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>HandleValidateToken</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Not Yet Implemented&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Then we update our <code>main.go</code> file to initialize the router and serve up our routes that will all issue error responses!</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>
<span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;net/http&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Hello, World!&#34;</span><span class=p>)</span>
	<span class=nf>InitializeHttpServer</span><span class=p>(</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>InitializeHttpServer</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>r</span> <span class=o>:=</span> <span class=nf>NewRouter</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>log</span><span class=p>.</span><span class=nf>Panic</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span><span class=p>)</span>
<span class=p>}</span>


<span class=s>`</span><span class=s>
</span><span class=s>
</span><span class=s>I like to use postman to test my apis but you can curl it if you want.  Go ahead and send some POST requests to our endpoints and you&#39;ll get a simple 500 response with &#34;Not Yet Implemented&#34; as the response.
</span><span class=s>
</span><span class=s>Next we can either implement a service to handle these requests or we can implement the database interface.  I&#39;m going to elect to implement the database functionality because I&#39;m a bit of a database nerd.  BoltDB is a key/value store which is really all that we need for implementing an authentication database in a microservice.  I&#39;m not going to do anything fancy such as allowing token invalidation etc so this should be pretty simple! Let&#39;s make a new file called </span><span class=s>`</span><span class=nx>db</span><span class=p>.</span><span class=k>go</span><span class=s>`</span><span class=s>
</span><span class=s>
</span><span class=s></span><span class=s>`</span><span class=s>`</span><span class=s>`</span><span class=k>go</span>
<span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;encoding/json&#34;</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;strconv&#34;</span>

	<span class=s>&#34;github.com/boltdb/bolt&#34;</span>
<span class=p>)</span>

<span class=c1>// Interface for the DB Client
</span><span class=c1></span><span class=kd>type</span> <span class=nx>IDBClient</span> <span class=kd>interface</span> <span class=p>{</span>
	<span class=nf>Initialize</span><span class=p>(</span><span class=nx>filepath</span> <span class=kt>string</span><span class=p>)</span>
	<span class=nf>Open</span><span class=p>(</span><span class=p>)</span>
	<span class=nf>Close</span><span class=p>(</span><span class=p>)</span>
	<span class=nf>CreateUser</span><span class=p>(</span><span class=nx>u</span> <span class=nx>User</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
	<span class=nf>Login</span><span class=p>(</span><span class=nx>email</span><span class=p>,</span> <span class=nx>password</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
	<span class=nf>CheckUserIsNew</span><span class=p>(</span><span class=nx>email</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
<span class=c1>// Struct to handle the DB Connection
</span><span class=c1></span><span class=kd>type</span> <span class=nx>DBClient</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>client</span>   <span class=o>*</span><span class=nx>bolt</span><span class=p>.</span><span class=nx>DB</span>
	<span class=nx>filepath</span> <span class=kt>string</span>
<span class=p>}</span>

<span class=c1>// The DB Client for the application
</span><span class=c1></span><span class=kd>var</span> <span class=nx>DB</span> <span class=nx>IDBClient</span>

<span class=kd>const</span> <span class=p>(</span>
	<span class=nx>usersBucketName</span> <span class=kt>string</span> <span class=p>=</span> <span class=s>&#34;Users&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>Open</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>

<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>Initialize</span><span class=p>(</span><span class=nx>filepath</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>

<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>Close</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>

<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>CreateUser</span><span class=p>(</span><span class=nx>u</span> <span class=nx>User</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Not Implemented&#34;</span><span class=p>)</span>
<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>Login</span><span class=p>(</span><span class=nx>email</span><span class=p>,</span> <span class=nx>password</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Not Implemented&#34;</span><span class=p>)</span>
<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>CheckUserIsNew</span><span class=p>(</span><span class=nx>email</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Not Implemented&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>I&rsquo;m no go pro but this is how I understand that go apps are organized. My OOP career has drilled into my head that you should always program against an interface so when they exist, I use them.</p><p>The DBClient is sort of like a class. We&rsquo;re going to use it to store the bolt client, the location of the filepath, and then we are going to declare methods for it by using the syntax that is seen below. The <code>var DB IDBClient</code> line helps us to initialize the database handler and makes sure that our initialization of DBClient has all the functions as defined by the IDBClient interface. Clear as mud? Let&rsquo;s do it then!</p><p>First we may as well handle the easy stuff: Initialize, Open, and Close.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>Initialize</span><span class=p>(</span><span class=nx>filepath</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>db</span><span class=p>.</span><span class=nx>filepath</span> <span class=p>=</span> <span class=nx>filepath</span>
	<span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>txn</span> <span class=o>*</span><span class=nx>bolt</span><span class=p>.</span><span class=nx>Tx</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
		<span class=c1>// Initialize Users Bucket
</span><span class=c1></span>		<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>txn</span><span class=p>.</span><span class=nf>CreateBucketIfNotExists</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>usersBucketName</span><span class=p>)</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>err</span>
		<span class=p>}</span>
		<span class=k>return</span> <span class=kc>nil</span>
	<span class=p>}</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>Open</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>db</span><span class=p>.</span><span class=nx>filepath</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Filepath required for Database&#34;</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>d</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>bolt</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>filepath</span><span class=p>,</span> <span class=mo>0600</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>db</span><span class=p>.</span><span class=nx>client</span> <span class=p>=</span> <span class=nx>d</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>Close</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>db</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Close</span><span class=p>(</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>The Initialize function takes a filepath. This would be the same as taking in an SQL connection string in any other app. This makes it way easier for us to set up our environment for testing and for production. We can set up and tear down test databases while leaving our production an development databases alone. We then set up the buckets that our app is going to need (which is just a <code>Users</code> bucket for now).</p><p>The Open function does just that. Opens the database and applies it to it&rsquo;s client parameter. The close does just what you&rsquo;d expect a close function to do as well.</p><p>We may as well write the functional code now. We&rsquo;ll start with <code>CreateUser</code> and <code>CheckUserIsNew</code></p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>CreateUser</span><span class=p>(</span><span class=nx>u</span> <span class=nx>User</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>isNew</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>CheckUserIsNew</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>Email</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>isNew</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>txn</span> <span class=o>*</span><span class=nx>bolt</span><span class=p>.</span><span class=nx>Tx</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
		<span class=nx>b</span> <span class=o>:=</span> <span class=nx>txn</span><span class=p>.</span><span class=nf>Bucket</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>usersBucketName</span><span class=p>)</span><span class=p>)</span>
		<span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nf>NextSequence</span><span class=p>(</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>err</span>
		<span class=p>}</span>
		<span class=nx>u</span><span class=p>.</span><span class=nx>ID</span> <span class=p>=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span><span class=p>)</span>
		<span class=nx>u</span><span class=p>.</span><span class=nf>HashPassword</span><span class=p>(</span><span class=p>)</span>
		<span class=nx>userBytes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>err</span>
		<span class=p>}</span>
		<span class=nx>err</span> <span class=p>=</span> <span class=nx>b</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>Email</span><span class=p>)</span><span class=p>,</span> <span class=nx>userBytes</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>err</span>
		<span class=p>}</span>
		<span class=k>return</span> <span class=kc>nil</span>
	<span class=p>}</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>CheckUserIsNew</span><span class=p>(</span><span class=nx>email</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>View</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>bolt</span><span class=p>.</span><span class=nx>Tx</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
		<span class=nx>b</span> <span class=o>:=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Bucket</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>usersBucketName</span><span class=p>)</span><span class=p>)</span>
		<span class=nx>userBytes</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>email</span><span class=p>)</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>userBytes</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;User with email %s already exists&#34;</span><span class=p>,</span> <span class=nx>email</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=k>return</span> <span class=kc>nil</span>
	<span class=p>}</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p><code>CheckUserIsNew</code> is just a helper function to determine if our user exists in the database already or not. This is helpful as we don&rsquo;t really have key constraints in the embedded database. We need to ensure that we&rsquo;re not just re-registering users when a registration request comes in. The <code>CreateUser</code> calls this as soon as possible and if a user exists, it returns an error. The <code>CreateUser</code> will then return this error to the calling function.</p><p>We can write some tests for this now! in <code>db_test.go</code> let&rsquo;s set up some cases</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;os&#34;</span>
	<span class=s>&#34;testing&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>TestMain</span><span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>M</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>DB</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>DBClient</span><span class=p>{</span><span class=p>}</span>
	<span class=nx>DB</span><span class=p>.</span><span class=nf>Initialize</span><span class=p>(</span><span class=s>&#34;./bolt-test.db&#34;</span><span class=p>)</span>
	<span class=nx>retCode</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>os</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=s>&#34;./bolt-test.db&#34;</span><span class=p>)</span>
	<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=nx>retCode</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>TestCheckUserShouldNotReturnError</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>email</span> <span class=o>:=</span> <span class=s>&#34;test@domain.com&#34;</span>
	<span class=nx>isNew</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>CheckUserIsNew</span><span class=p>(</span><span class=nx>email</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;An Error was thrown that should not have been&#34;</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>isNew</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;User shouldn&#39;t Exist but does&#34;</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>TestCreateUser</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>u</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
		<span class=nx>Email</span><span class=p>:</span>    <span class=s>&#34;test@domain.com&#34;</span><span class=p>,</span>
		<span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;password&#34;</span><span class=p>,</span>
	<span class=p>}</span>
	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>CreateUser</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>result</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;User not created&#34;</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>TestCreateUserWithSameEmailShouldFail</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>u</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
		<span class=nx>Email</span><span class=p>:</span>    <span class=s>&#34;test@domain.com&#34;</span><span class=p>,</span>
		<span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;password&#34;</span><span class=p>,</span>
	<span class=p>}</span>
	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>CreateUser</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>result</span> <span class=o>==</span> <span class=kc>true</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;User not created&#34;</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>TestCheckUserShouldReturnError</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>email</span> <span class=o>:=</span> <span class=s>&#34;test@domain.com&#34;</span>
	<span class=nx>isNew</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>CheckUserIsNew</span><span class=p>(</span><span class=nx>email</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>isNew</span> <span class=o>==</span> <span class=kc>true</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;User Should Exist but doesn&#39;t&#34;</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;Error should have been thrown&#34;</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

</code></pre></div><p>We first make sure that our <code>CheckUserExists</code> function returns false. We then test some <code>CreateUser</code> functionality and then finally make sure that our <code>CheckUserExists</code> returns an error as the account does already exist. Follow? Sweet! Let&rsquo;s move on to the <code>Login</code> function!</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=c1>// db.go
</span><span class=c1></span><span class=c1>// ...
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>DBClient</span><span class=p>)</span> <span class=nf>Login</span><span class=p>(</span><span class=nx>email</span><span class=p>,</span> <span class=nx>password</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>View</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>bolt</span><span class=p>.</span><span class=nx>Tx</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
		<span class=nx>b</span> <span class=o>:=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Bucket</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>usersBucketName</span><span class=p>)</span><span class=p>)</span>
		<span class=nx>userBytes</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>email</span><span class=p>)</span><span class=p>)</span>
		<span class=nx>u</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span><span class=p>}</span>
		<span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>userBytes</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>u</span><span class=p>)</span>
		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>u</span><span class=p>.</span><span class=nf>CheckPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;ERROR: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
			<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Invalid Login Attempt for User: %s&#34;</span><span class=p>,</span> <span class=nx>email</span><span class=p>)</span>
			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Invalid Email/Password Combnation&#34;</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=k>return</span> <span class=kc>nil</span>
	<span class=p>}</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=s>&#34;nope&#34;</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=s>&#34;yep&#34;</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>Here we take an email and password, load up the user from the database, check if the password is the valid hash, and then return a string response. We will replace this &ldquo;nope&rdquo; and &ldquo;yep&rdquo; with a token later but for now we will just use these.</p><p>And again let&rsquo;s make sure that we have some test cases for <code>Login</code>:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=c1>// db_test.go
</span><span class=c1></span><span class=c1>// ...
</span><span class=c1></span><span class=kd>func</span> <span class=nf>TestValidLogin</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>Login</span><span class=p>(</span><span class=s>&#34;test@domain.com&#34;</span><span class=p>,</span> <span class=s>&#34;password&#34;</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>TestInvalidLogin</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>Login</span><span class=p>(</span><span class=s>&#34;test@domain.com&#34;</span><span class=p>,</span> <span class=s>&#34;wrongpassword&#34;</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;The password should have been invalid&#34;</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Check our code again using <code>go test</code> and we should pass everything.</p><hr><h1 id=a-note-on-tests>A Note on Tests</h1><p>This isn&rsquo;t really TDD. This is what we call lazy testing. Typically you&rsquo;d write tests to test your functionality and THEN implement the code. This allows you to come up with as many different scenarios as possible and then write resilient code. That&rsquo;s outside the scope of this little learning activity but some tests are better than no tests.</p><hr><p>Now that we have our core functionality in controllers we need to expose it externally. We will do this by going back to our <code>router.go</code> file and adding some real functionality as opposed to just throwing random errors :)</p><p>Logically, we&rsquo;ll implement the registration route first:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>
<span class=kd>func</span> <span class=nf>HandleRegistration</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
	<span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
	<span class=nx>decoder</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>decoder</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nf>WriteError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Error Decoding User&#34;</span><span class=p>)</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>success</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>CreateUser</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nf>WriteError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=k>return</span>
	<span class=p>}</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Status: %t&#34;</span><span class=p>,</span> <span class=nx>success</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>WriteError</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>statusCode</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>statusCode</span><span class=p>)</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=p>)</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>You&rsquo;ll notice that I added a <code>WriteError</code> helper function since it&rsquo;s easier than repeating this code over and over again. Passing the actual error through to the client is PROBABLY not a great idea in a production environment though.</p><p>Before we can successfully build and run this, we will need to initialize our database. In <code>main.go</code> we&rsquo;ll add a helper function and call it before we initialize the Router.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>
<span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;net/http&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Hello, World!&#34;</span><span class=p>)</span>
	<span class=nf>InitializeDatabase</span><span class=p>(</span><span class=p>)</span>
	<span class=nf>InitializeHttpServer</span><span class=p>(</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>InitializeHttpServer</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>r</span> <span class=o>:=</span> <span class=nf>NewRouter</span><span class=p>(</span><span class=p>)</span>
	<span class=nx>log</span><span class=p>.</span><span class=nf>Panic</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>InitializeDatabase</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>DB</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>DBClient</span><span class=p>{</span><span class=p>}</span>
	<span class=nx>DB</span><span class=p>.</span><span class=nf>Initialize</span><span class=p>(</span><span class=s>&#34;bolt.db&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Now - Build it and run! <code>go build</code> and <code>./whatever-your-foldername-is</code> if you&rsquo;re on *nix or <code>./whatever-your-foldername-is.exe</code> if you&rsquo;re on windows! I use Postman, you can use CURL if you like, but no matter what let&rsquo;s send a registration request to <code>http://localhost:8080/register</code> with a payload of</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;email&#34;</span><span class=p>:</span><span class=s2>&#34;someemail@domain.com&#34;</span><span class=p>,</span>
  <span class=nt>&#34;password&#34;</span><span class=p>:</span><span class=s2>&#34;password&#34;</span>
<span class=p>}</span>
</code></pre></div><p>You should get a response of: <code>Status: true</code>. Success! We have registered a user!</p><p>Now we should allow this user to login. We&rsquo;ll implement the <code>HandleLogin</code> handler next.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>HandleLogin</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
	<span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
	<span class=nx>decoder</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>decoder</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nf>WriteError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Error Decoding User&#34;</span><span class=p>)</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>status</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>Login</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Password</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nf>WriteError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=k>return</span>
	<span class=p>}</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Buld and run again! Send a POST to <code>http://localhost:8080/login</code> with the payload</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;email&#34;</span><span class=p>:</span><span class=s2>&#34;someemail@domain.com&#34;</span><span class=p>,</span>
  <span class=nt>&#34;password&#34;</span><span class=p>:</span><span class=s2>&#34;password&#34;</span>
<span class=p>}</span>
</code></pre></div><p>And you should get the message: <code>yep</code>.</p><p>Anyways, this post has gotten REALLY long. So check back for part 2 where we implement the token service, the <code>tokenValidation</code> endpoints, and make some more interesting responses that can be digested better by a calling service.</p><p>Keep Hacking!</p></article><section class="article labels"><a class=category href=/categories/golang/>golang</a><a class=tag href=/tags/golang/>golang</a></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/2018/go-micro-services-and-embedded-databases-part-2/><span class="iconfont icon-article"></span>Go - Micro-services and Embedded Databases [Part 2]</a></p><p><a class=link href=/posts/2018/fetching-data-with-react/><span class="iconfont icon-article"></span>Fetching data with react</a></p></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>©2020 James Hughes.</p><p class=powerby><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p></div></section></body></html>