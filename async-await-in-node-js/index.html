<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>Async / Await in Node.js&nbsp;&ndash;&nbsp;James Hughes</title><link rel=stylesheet href=/css/core.min.99d761621eb15531f47d6f109c742c4d2f97f9c10fed380e3da27af7676a27a1fb5968bfbd3207717f11d40ad1d68b92.css integrity=sha384-mddhYh6xVTH0fW8QnHQsTS+X+cEP7TgOPaJ692dqJ6H7WWi/vTIHcX8R1ArR1ouS><meta name=twitter:card content="summary"><meta name=twitter:title content="Async / Await in Node.js"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">James Hughes</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories/>Categories</a><a class="nav item" href=/tags/>Tags</a><a class="nav item" href></a><a class="nav item" href></a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">Async / Await in Node.js</h1><p class="article date">Thursday, May 31, 2018</p></section><article class="article markdown-body"><p>The Async / Await functionality introduced into Node.js in v7.10.0 is legitimately a godsend. The Async / Await paradigm works with promises to do exactly what the paradigm implies. It will asynchronously call the function and await it&rsquo;s response before continuing on with the rest of the function. Previously, you could do this with promise chaining. Passing results from one promise to the next. Where this issue fell apart is when you needed to use the result of Promise 1 in Promise 4. You would need to somehow pass the result of Promise 1 through Promises 2 and 3 in order to use them in promise 4.</p><p>Here&rsquo;s an example of a relatively easy to read chain of promises that I use in a production application to generate a user&rsquo;s timesheet.</p><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript><span class=kd>function</span> <span class=nx>getTimesheet</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>date</span><span class=p>,</span> <span class=nx>offset</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>getCompanyConfig</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>getTimesheetObject</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>config</span><span class=p>,</span> <span class=nx>result</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>date</span><span class=p>,</span> <span class=nx>offset</span><span class=p>)</span><span class=p>;</span>
      <span class=p>}</span><span class=p>)</span>
      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=p>(</span><span class=nx>timesheetObject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>executeTimesheetRequest</span><span class=p>(</span><span class=nx>timesheetObject</span><span class=p>)</span><span class=p>;</span>
      <span class=p>}</span><span class=p>)</span>
      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=p>(</span><span class=nx>timesheetBuffer</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=nx>resolve</span><span class=p>(</span><span class=nx>timesheetBuffer</span><span class=p>)</span><span class=p>;</span>
      <span class=p>}</span><span class=p>)</span>
      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=p>;</span>
        <span class=nx>reject</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=p>;</span>
      <span class=p>}</span><span class=p>)</span><span class=p>;</span>
  <span class=p>}</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Imagine this with callback hell. I thought promises were delightful until async / await was introduced.Essentially this function takes in a user, the date they&rsquo;re requesting a timesheet for, and the timezone_offset (calculated from the request object as we&rsquo;re located in multiple timezones). The function returns a promise of a binary buffer of the excel-based timesheet report required for legacy systems and for sign off by managers and clients.</p><p>Now to refactor this as a beautiful async / await function!</p><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript><span class=nx>async</span> <span class=kd>function</span> <span class=nx>getTimesheet</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>date</span><span class=p>,</span> <span class=nx>offset</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>try</span> <span class=p>{</span>
      <span class=kd>let</span> <span class=nx>config</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>getCompanyConfig</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span><span class=p>;</span>
      <span class=kd>let</span> <span class=nx>timesheetObject</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>getTimesheetObject</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>config</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>date</span><span class=p>,</span> <span class=nx>offset</span><span class=p>)</span><span class=p>;</span>
      <span class=kd>let</span> <span class=nx>buffer</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>executeTimesheetRequest</span><span class=p>(</span><span class=nx>timesheetObject</span><span class=p>)</span><span class=p>;</span>
      <span class=k>return</span> <span class=nx>buffer</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=p>;</span>
    <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>There we have it. The code is way more readable and flexible. If i needed to pass that configuration object into by executeTimesheetRequest() function then I could just do it instead of having to find inventive ways of chaining the config through the getTimesheetObject() function. I&rsquo;ve even left this open enough to refactor the getcompanyConfig() function into two separate functions (as I originally intended) but had problems with returning the results of two promises to the getTimesheetObject() function.</p><p>In the first bit of code it is obvious that we need to do some extra work to get both the user and config object to chain into the next function.</p><p>Here is an example of my getCompanyConfig function that I&rsquo;m going to also convert to async/await:</p><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript><span class=kd>function</span> <span class=nx>getCompanyConfig</span><span class=p>(</span><span class=nx>userId</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>User</span><span class=p>.</span><span class=nx>findById</span><span class=p>(</span><span class=nx>userId</span><span class=p>,</span> <span class=p>{</span>
      <span class=nx>include</span><span class=o>:</span> <span class=p>[</span><span class=nx>models</span><span class=p>.</span><span class=nx>Company</span><span class=p>]</span>
    <span class=p>}</span><span class=p>)</span>
      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>exportConfiguration</span><span class=p>.</span><span class=nx>templates</span><span class=p>[</span><span class=nx>u</span><span class=p>.</span><span class=nx>Company</span><span class=p>.</span><span class=nx>name</span><span class=p>]</span><span class=p>)</span> <span class=p>{</span>
          <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;No Configuration Avaialable for Company: &#39;</span> <span class=o>+</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Company</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span><span class=p>;</span>
          <span class=nx>reject</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;No Configuration available for company: &#39;</span> <span class=o>+</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Company</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
          <span class=nx>resolve</span><span class=p>(</span><span class=p>{</span>
            <span class=nx>user</span><span class=o>:</span> <span class=nx>u</span><span class=p>,</span>
            <span class=nx>config</span><span class=o>:</span> <span class=nx>exportConfiguration</span><span class=p>.</span><span class=nx>config</span>
          <span class=p>}</span><span class=p>)</span><span class=p>;</span>
        <span class=p>}</span>
      <span class=p>}</span><span class=p>)</span>
      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error Finding User&#39;</span><span class=p>)</span><span class=p>;</span>
        <span class=nx>reject</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=p>;</span>
      <span class=p>}</span><span class=p>)</span>
  <span class=p>}</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>It&rsquo;s pretty verbose and a touch confusing.</p><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript><span class=nx>async</span> <span class=kd>function</span> <span class=nx>getCompanyConfig</span><span class=p>(</span><span class=nx>userId</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=kd>let</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findById</span><span class=p>(</span><span class=nx>userId</span><span class=p>,</span> <span class=p>{</span><span class=nx>include</span><span class=o>:</span><span class=p>[</span><span class=nx>models</span><span class=p>.</span><span class=nx>Company</span><span class=p>]</span><span class=p>}</span><span class=p>)</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>exportConfiguration</span><span class=p>.</span><span class=nx>templates</span><span class=p>[</span><span class=nx>user</span><span class=p>.</span><span class=nx>Company</span><span class=p>.</span><span class=nx>name</span><span class=p>]</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;No Template Available for Company: &#39;</span><span class=o>+</span><span class=nx>u</span><span class=p>.</span><span class=nx>Company</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=p>{</span>
      <span class=nx>user</span><span class=o>:</span> <span class=nx>user</span><span class=p>,</span>
      <span class=nx>config</span><span class=o>:</span> <span class=nx>exportConfiguration</span><span class=p>.</span><span class=nx>config</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=p>{</span>
    <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
  <span class=p>}</span> 
<span class=p>}</span>
</code></pre></div><p>Smaller. Tighter. Cleaner. I can now also break this into two smaller functions that return more meaningful things. 1 - The getUser function and the getCompanyConfig function which will return ONLY the user information and the company information as required.</p><p>First we&rsquo;ll take the user definition out of the getCompanyConfig controller and put it in the getTimesheet function. Then we will adjust our getCompanyConfig function to only handle validating and returning the configuration object.</p><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript><span class=nx>async</span> <span class=kd>function</span> <span class=nx>getTimesheet</span><span class=p>(</span><span class=nx>userId</span><span class=p>,</span> <span class=nx>date</span><span class=p>,</span> <span class=nx>offset</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=kd>let</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findById</span><span class=p>(</span><span class=nx>userId</span><span class=p>,</span> <span class=p>{</span> <span class=nx>include</span><span class=o>:</span> <span class=p>[</span><span class=nx>models</span><span class=p>.</span><span class=nx>Company</span><span class=p>]</span> <span class=p>}</span><span class=p>)</span><span class=p>;</span>
    <span class=kd>let</span> <span class=nx>config</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>getCompanyConfig</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Company</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span><span class=p>;</span>
    <span class=kd>let</span> <span class=nx>timesheetObject</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>getTimesheetObject</span><span class=p>(</span><span class=nx>config</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>date</span><span class=p>,</span> <span class=nx>offset</span><span class=p>)</span><span class=p>;</span>
    <span class=kd>let</span> <span class=nx>buffer</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>executeTimesheetRequest</span><span class=p>(</span><span class=nx>timesheetObject</span><span class=p>)</span><span class=p>;</span>
    <span class=k>return</span> <span class=nx>buffer</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error Retreiving Timesheet&#39;</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span><span class=p>;</span>
    <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript><span class=nx>async</span> <span class=kd>function</span> <span class=nx>getCompanyConfig</span><span class=p>(</span><span class=nx>companyName</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>exportConfiguration</span><span class=p>.</span><span class=nx>templates</span><span class=p>[</span><span class=nx>companyName</span><span class=p>]</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;No Template Available for Company: &#39;</span> <span class=o>+</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Company</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nx>exportConfiguration</span><span class=p>.</span><span class=nx>config</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>There we have it.</p><p>The Async / Await functionality has made this small portion of code WAY more readable and way more maintainable. I can now have functions handle specific actions and I can successfully handle the behaviour in a way that feels more synchronous but while not blocking the event loop.</p><p>Hopefully this has inspired you to give it a go!</p></article><section class="article labels"><a class=category href=/categories/nodejs/>nodejs</a><a class=category href=/categories/async/await/>async/await</a><a class=category href=/categories/asynchronous/>asynchronous</a><a class=tag href=/tags/nodejs/>nodejs</a><a class=tag href=/tags/async/await/>async/await</a><a class=tag href=/tags/asynchronous/>asynchronous</a></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/morse-code-in-go/><span class="iconfont icon-article"></span>Learning Go - Morse Code!</a></p><p><a class=link href=/my-concept2-model-d-lets-get-after-it/><span class="iconfont icon-article"></span>My Concept2 Model D - Let's get after it!</a></p></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>©2020 James Hughes.</p><p class=powerby><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-61647183-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>