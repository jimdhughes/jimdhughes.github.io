<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>Docker Seq Setup With API Key&nbsp;&ndash;&nbsp;James Hughes</title><link rel=stylesheet href=/css/core.min.99d761621eb15531f47d6f109c742c4d2f97f9c10fed380e3da27af7676a27a1fb5968bfbd3207717f11d40ad1d68b92.css integrity=sha384-mddhYh6xVTH0fW8QnHQsTS+X+cEP7TgOPaJ692dqJ6H7WWi/vTIHcX8R1ArR1ouS><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker Seq Setup With API Key"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">James Hughes</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories/>Categories</a><a class="nav item" href=/tags/>Tags</a><a class="nav item" href></a><a class="nav item" href></a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">Docker Seq Setup With API Key</h1><p class="article date">Friday, July 31, 2020</p></section><article class="article markdown-body"><h1 id=heres-what-happened>Here&rsquo;s what happened</h1><p>I was playing around with a system that my team was building at work. The system, when deployed, will have 3 components living on 3 different servers with their networks locked down. You can think of it like:</p><p>a &mdash; b &mdash; c</p><p>Server a can talk to server b, b to a and c, and c to b.</p><p>To test these without deploying to the actual environment, I figured I may as well dockerize it! Frequenting our stack at work is <a href=https://datalust.co/seq target=_blank>Seq</a> which is a logging platform. Our components write to a common Seq setup to help us with debugging.</p><p>Originally, I wasn&rsquo;t going to include the Seq configuration in my docker stack mostly because I was lazy. However I ran into an issue in my e2e test and I couldn&rsquo;t, for the life of me, debug it. So instead of doing it right the first time, I had to go back and do it again. I had to add Seq to the stack.</p><p>Seq requires an API Key for tools to log to it but you cannot configure the Seq docker image to have an API key by default. Since my setup is a &lsquo;run and throwaway&rsquo; setup, I wasn&rsquo;t mounting any volumes so I would lose any keys that I create in my Seq instance. I set out on a mission to find a better way</p><h1 id=proposed-solutions>Proposed Solutions</h1><p>I found a few solutions on the web. Most of them were derivatives of <a href=https://docs.datalust.co/discuss/5e552e8bdc8f4c3e8d41d4a4 target=_blank>this forum post</a>. This solution suggests to load up the seqcli and to run a command on startup. Since seq takes a while to startup, you need to wait for it to come up. The forum suggests that we can fix this by doing something like this:</p><pre><code class=language-terminal data-lang=terminal>command: /bin/bash -c &quot;sleep 10; /bin/seqcli/seqcli apikey create --title='newapikey' --token='123456' --server=http://seq&quot;
</code></pre><p>For the life of me, I couldn&rsquo;t get this to work.
I think it&rsquo;s because the seqcli docker image <em>must</em> run the <code>seqcli</code> command by default so any bash commands that I try to run just end up with an error stating:</p><pre><code class=language-terminal data-lang=terminal>Usage: seqcli &lt;command&gt; [&lt;args&gt;]
Type `seqcli help` for available commands
</code></pre><p>After smacking my head against the wall, I deleted most of the start of the command. I ended up with this:</p><pre><code class=language-terminal data-lang=terminal>command: apikey create -t newapikey --token 12345678901234567890 -s http://seq
</code></pre><p>It worked! Sort of. Since I wasn&rsquo;t waiting for seq to start up, I just kept getting the error:</p><pre><code class=language-terminal data-lang=terminal>seqcli_1         | The command failed: Connection refused
</code></pre><p>Which is expected since the image isn&rsquo;t up yet.</p><p>After some mulling, I remembered that docker-compose has the awesome <code>restart</code> feature which will&mldr; restart your container after a failure. Since this was issuing a failure command, I set the <code>restart</code> as follows</p><pre><code class=language-terminal data-lang=terminal>restart: on-failure
</code></pre><p>On my next docker-compose up, it worked! Below is a minimal dockerfile to get seq up and running</p><h1 id=docker-compose>Docker-Compose</h1><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span><span class=w></span><span class=k>services</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>seqcli</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>image</span><span class=p>:</span><span class=w> </span>datalust/seqcli<span class=p>:</span>latest<span class=w>
</span><span class=w>    </span><span class=k>command</span><span class=p>:</span><span class=w> </span>apikey<span class=w> </span>create<span class=w> </span>-t<span class=w> </span>newapikey<span class=w> </span>--token<span class=w> </span><span class=m>12345678901234567890</span><span class=w> </span>-s<span class=w> </span>http<span class=p>:</span>//seq<span class=w>
</span><span class=w>    </span><span class=k>depends_on</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span>- seq<span class=w>
</span><span class=w>    </span><span class=k>restart</span><span class=p>:</span><span class=w> </span>on-failure<span class=w>
</span><span class=w>    </span><span class=k>networks</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span>- seqnetwork<span class=w>
</span><span class=w>  </span><span class=k>seq</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>image</span><span class=p>:</span><span class=w> </span>datalust/seq<span class=p>:</span>latest<span class=w>
</span><span class=w>    </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span>- ACCEPT_EULA=Y<span class=w>
</span><span class=w>    </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span>- <span class=m>8003</span><span class=p>:</span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=k>networks</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>      </span>- seqnetwork<span class=w>
</span><span class=w></span><span class=k>networks</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>seqnetwork</span><span class=p>:</span><span class=w>
</span></code></pre></div><p>Paste this into a <code>docker-compose.yml</code> file and run it. I&rsquo;ve bound seq to a local port <code>8003</code> so I can see if it is working.</p><p>Head over to <code>http://localhost:8003</code> to see the seq dashboard. Head to settings -> API Keys and you will see our very secret and not at all guessable key <code>12345678901234567890</code> Now you can pre-configure your docker-compose files to have an api key handed to all your services. Pretty decent right?</p><p>Hopefully this helps anyone that was stuck hacking around like I was earlier this week. This solution seems to work! Let me know if you have any better ideas below.</p></article><section class="article labels"><a class=category href=/categories/seq/>Seq</a><a class=category href=/categories/docker/>Docker</a><a class=tag href=/tags/seq/>Seq</a><a class=tag href=/tags/docker/>Docker</a></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/nerds-fixing-stuff-roof-leakpart-1/><span class="iconfont icon-article"></span>Nerds Fixing Stuff Roof Leak Part 1</a></p><p><a class=link href=/migrating-my-blog-from-ghost-to-hugo/><span class="iconfont icon-article"></span>Migrating my Blog from Ghost to Hugo</a></p></section><section class="article discussion"><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"https-blog-jimdhughes-com"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>Â©2020 James Hughes.</p><p class=powerby><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-61647183-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>